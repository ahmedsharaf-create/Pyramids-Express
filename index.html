<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyramids Express | Agent Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .dark .glass { background: rgba(0, 0, 0, 0.8); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ef4444; border-radius: 10px; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-white text-gray-900 overflow-x-hidden transition-colors duration-300">

    <!-- --- Navigation --- -->
    <nav id="navbar" class="fixed top-0 w-full z-50 border-b border-gray-100 bg-white/95 backdrop-blur-md transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3 cursor-pointer" onclick="navigateTo('home')">
                    <div id="logo-box" class="bg-black text-white w-8 h-8 rounded-md flex items-center justify-center font-bold text-lg transition-colors duration-300">pe</div>
                    <span id="brand-name" class="font-bold text-lg tracking-tight uppercase transition-colors duration-300 text-black">Pyramids Express</span>
                </div>

                <div class="hidden md:flex items-center space-x-6">
                    <button onclick="toggleTheme()" class="p-2 hover:opacity-70 transition-opacity">
                        <i data-lucide="moon" id="theme-icon-desktop" class="w-5 h-5"></i>
                    </button>
                    <div id="nav-links" class="flex items-center space-x-6"></div>
                </div>

                <div class="md:hidden flex items-center space-x-4">
                    <button onclick="toggleTheme()"><i data-lucide="moon" id="theme-icon-mobile" class="w-6 h-6"></i></button>
                    <button onclick="toggleMobileMenu()"><i data-lucide="menu" class="w-6 h-6"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <!-- --- Main Content Area --- -->
    <div id="app-root" class="min-h-screen pt-16"></div>

    <!-- --- Footer --- -->
    <footer id="main-footer" class="py-12 mt-20 border-t border-gray-100 bg-gray-50 transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <div class="flex justify-center space-x-6 mb-8 text-gray-400">
                <i data-lucide="linkedin" class="w-5 h-5 cursor-pointer hover:text-red-600 transition-colors"></i>
                <i data-lucide="mail" class="w-5 h-5 cursor-pointer hover:text-red-600 transition-colors"></i>
                <i data-lucide="map-pin" class="w-5 h-5 cursor-pointer hover:text-red-600 transition-colors"></i>
            </div>
            <p class="text-[10px] uppercase tracking-[0.3em] text-gray-400">Â© <span id="year"></span> Pyramids Express Quality App</p>
        </div>
    </footer>

    <!-- --- Auth Modal (Login & Sign Up) --- -->
    <div id="auth-modal" class="fixed inset-0 z-[100] hidden items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="toggleAuthModal(false)"></div>
        <div class="relative w-full max-w-sm p-8 rounded-3xl shadow-2xl bg-white dark:bg-gray-900 transition-colors">
            
            <div id="auth-view-login">
                <div class="text-center mb-8">
                    <div class="bg-red-600 text-white w-12 h-12 rounded-xl flex items-center justify-center font-bold text-2xl mx-auto mb-4">pe</div>
                    <h2 class="text-xl font-black uppercase tracking-tight dark:text-white">Express Portal</h2>
                    <p class="text-[10px] uppercase tracking-widest opacity-50 mt-1 dark:text-gray-400">Login to your account</p>
                </div>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="EMAIL ADDRESS" class="w-full px-4 py-3 text-[10px] font-bold tracking-widest uppercase border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 dark:text-white outline-none rounded-xl focus:border-red-600 transition-all" required>
                    <input type="password" id="login-pass" placeholder="PASSWORD" class="w-full px-4 py-3 text-[10px] font-bold tracking-widest uppercase border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 dark:text-white outline-none rounded-xl focus:border-red-600 transition-all" required>
                    <button type="submit" id="auth-submit-btn" class="w-full py-4 text-xs font-bold uppercase tracking-[0.2em] text-white bg-black hover:bg-gray-800 dark:bg-red-600 dark:hover:bg-red-700 rounded-xl transition-all shadow-lg flex justify-center items-center">
                        Authorize Session
                    </button>
                </form>
                <div class="mt-6 text-center space-y-4">
                    <button onclick="toggleAuthView('signup')" class="text-[10px] font-bold text-red-600 uppercase tracking-widest hover:underline">New Agent? Apply for access</button>
                    <p class="text-[9px] opacity-40 uppercase tracking-widest dark:text-gray-500">Admin: admin@pyramidsexpress.com</p>
                </div>
            </div>

            <div id="auth-view-signup" class="hidden">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-black uppercase tracking-tight dark:text-white">Agent Application</h2>
                    <p class="text-[10px] uppercase tracking-widest opacity-50 mt-1 dark:text-gray-400">Request account activation</p>
                </div>
                <form id="signup-form" class="space-y-3">
                    <input type="text" id="signup-name" placeholder="FULL NAME" class="w-full px-4 py-2.5 text-[10px] font-bold tracking-widest uppercase border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 dark:text-white outline-none rounded-xl focus:border-red-600 transition-all" required>
                    <input type="email" id="signup-email" placeholder="EMAIL ADDRESS" class="w-full px-4 py-2.5 text-[10px] font-bold tracking-widest uppercase border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 dark:text-white outline-none rounded-xl focus:border-red-600 transition-all" required>
                    <input type="password" id="signup-pass" placeholder="PASSWORD" class="w-full px-4 py-2.5 text-[10px] font-bold tracking-widest uppercase border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 dark:text-white outline-none rounded-xl focus:border-red-600 transition-all" required>
                    
                    <select id="signup-area" onchange="updateSignupShops()" class="w-full px-4 py-2.5 text-[10px] font-bold tracking-widest uppercase border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 dark:text-white outline-none rounded-xl focus:border-red-600 transition-all" required>
                        <option value="">SELECT AREA MANAGER</option>
                    </select>

                    <select id="signup-shop" class="w-full px-4 py-2.5 text-[10px] font-bold tracking-widest uppercase border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 dark:text-white outline-none rounded-xl focus:border-red-600 transition-all" required disabled>
                        <option value="">SELECT SHOP</option>
                    </select>

                    <button type="submit" id="signup-submit-btn" class="w-full py-4 text-xs font-bold uppercase tracking-[0.2em] text-white bg-red-600 hover:bg-red-700 rounded-xl transition-all shadow-lg flex justify-center items-center mt-2">
                        Submit Application
                    </button>
                </form>
                <div class="mt-4 text-center">
                    <button onclick="toggleAuthView('login')" class="text-[10px] font-bold opacity-60 uppercase tracking-widest hover:underline dark:text-white">Already registered? Login</button>
                </div>
            </div>

            <button onclick="toggleAuthModal(false)" class="absolute top-6 right-6 opacity-30 hover:opacity-100 dark:text-white">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- --- Firebase SDKs --- -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- Firebase Configuration ---
        // IMPORTANT: Ensure this config matches your Firebase Project Console EXACTLY
        const myFirebaseConfig = {
            apiKey: "AIzaSyDDBFnDT5NDZdqqSfVA-uQ283DaagdneKc",
            authDomain: "pyramids-express-52a27.firebaseapp.com",
            projectId: "pyramids-express-52a27",
            storageBucket: "pyramids-express-52a27.firebasestorage.app",
            messagingSenderId: "806262842725",
            appId: "1:806262842725:web:6863c2a063949936abbd49",
            measurementId: "G-3ZR6009M3R"
        };

        const firebaseConfig = myFirebaseConfig;
        const appId = "pyramids-express-52a27";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.state = {
            isLoggedIn: false,
            isAdmin: false,
            user: null,
            darkMode: false,
            currentPage: 'home',
            materials: {
                'orange-info': [],
                'corporate': [],
                'incentives': []
            },
            users: [],
            shops: [],
            requests: [] 
        };

        const INITIAL_SHOP_DATA = [
            { shop: "EXP El Eskandrany", manager: "Abdallah Ibrahim" },
            { shop: "EXP El Wardian", manager: "Abdallah Ibrahim" },
            { shop: "EXP Elkabary", manager: "Abdallah Ibrahim" },
            { shop: "EXP Karmouz", manager: "Abdallah Ibrahim" },
            { shop: "EXP Karmoz", manager: "Abdallah Ibrahim" },
            { shop: "OB. Bashayer Elkhair", manager: "Abdallah Ibrahim" },
            { shop: "OB. Bawalino", manager: "Abdallah Ibrahim" },
            { shop: "OB. El Werdian", manager: "Abdallah Ibrahim" },
            { shop: "OB. Ghet Elenab", manager: "Abdallah Ibrahim" },
            { shop: "OB. Moharam beck", manager: "Abdallah Ibrahim" },
            { shop: "EXP El Bahr El Azam", manager: "Ahmed Bahgat" },
            { shop: "EXP Embaba 2", manager: "Ahmed Bahgat" },
            { shop: "EXP Giza Mall", manager: "Ahmed Bahgat" },
            { shop: "EXP Hawamdya", manager: "Ahmed Bahgat" },
            { shop: "EXP Imbaba", manager: "Ahmed Bahgat" },
            { shop: "EXP Omranya", manager: "Ahmed Bahgat" },
            { shop: "EXP Ramsis Sq", manager: "Ahmed Bahgat" },
            { shop: "Fr Down Town", manager: "Ahmed Bahgat" },
            { shop: "Fr El Haram", manager: "Ahmed Bahgat" },
            { shop: "Fr Omrania", manager: "Ahmed Bahgat" },
            { shop: "OB. Al Mahata", manager: "Ahmed Bahgat" },
            { shop: "OB. Awseem", manager: "Ahmed Bahgat" },
            { shop: "OB. Bashteel", manager: "Ahmed Bahgat" },
            { shop: "OB. El Oroba", manager: "Ahmed Bahgat" },
            { shop: "OB. Embaba 1", manager: "Ahmed Bahgat" },
            { shop: "OB. Embaba2", manager: "Ahmed Bahgat" },
            { shop: "OB. Meit Oukba", manager: "Ahmed Bahgat" },
            { shop: "OB. Tawfikia Square", manager: "Ahmed Bahgat" },
            { shop: "EXP Damietta", manager: "Ahmed Elgendy" },
            { shop: "EXP Manzala", manager: "Ahmed Elgendy" },
            { shop: "EXP Qasaseen", manager: "Ahmed Elgendy" },
            { shop: "Fr Port Said Canal", manager: "Ahmed Elgendy" },
            { shop: "OB. AboKhalifa", manager: "Ahmed Elgendy" },
            { shop: "OB. PortSaid Belal Ibn Rabah", manager: "Ahmed Elgendy" },
            { shop: "OB. PortSaid Elrebat", manager: "Ahmed Elgendy" },
            { shop: "EXP Amria", manager: "Ahmed Moharam" },
            { shop: "EXP Bahary", manager: "Ahmed Moharam" },
            { shop: "EXP El Betash", manager: "Ahmed Moharam" },
            { shop: "EXP El Nakhil", manager: "Ahmed Moharam" },
            { shop: "EXP Manshya", manager: "Ahmed Moharam" },
            { shop: "EXP Ras Elteen", manager: "Ahmed Moharam" },
            { shop: "EXP Saba Banat", manager: "Ahmed Moharam" },
            { shop: "Fr Agami", manager: "Ahmed Moharam" },
            { shop: "OB. Matar", manager: "Ahmed Moharam" },
            { shop: "OB. Tera 1", manager: "Ahmed Moharam" },
            { shop: "OB. Zahrya", manager: "Ahmed Moharam" },
            { shop: "EXP Abu Tesht", manager: "Amir Nakhla" },
            { shop: "EXP El Gouna", manager: "Amir Nakhla" },
            { shop: "EXP Farshout", manager: "Amir Nakhla" },
            { shop: "EXP Nagaa Hamady", manager: "Amir Nakhla" },
            { shop: "EXP Qeft", manager: "Amir Nakhla" },
            { shop: "EXP Qena Down Town", manager: "Amir Nakhla" },
            { shop: "EX Qous New", manager: "Amir Nakhla" },
            { shop: "EXP Saqulta", manager: "Amir Nakhla" },
            { shop: "EXP Sohag", manager: "Amir Nakhla" },
            { shop: "Fr Naga Hamady", manager: "Amir Nakhla" },
            { shop: "Fr Sohag", manager: "Amir Nakhla" },
            { shop: "OB. Bardis", manager: "Amir Nakhla" },
            { shop: "OB. Hagaza", manager: "Amir Nakhla" },
            { shop: "EXP Qena New", manager: "Amir Nakhla" },
            { shop: "EXP Ismailia3", manager: "Amr Ali" },
            { shop: "EXP Port Fouad", manager: "Amr Ali" },
            { shop: "EXP Port Said2", manager: "Amr Ali" },
            { shop: "EXP PortSaid", manager: "Amr Ali" },
            { shop: "Fr Ismailia", manager: "Amr Ali" },
            { shop: "OB. PortSaid El Manakh", manager: "Amr Ali" },
            { shop: "EXP Ahmed Al Zomor", manager: "Eslam Gouda" },
            { shop: "EXP El Marg", manager: "Eslam Gouda" },
            { shop: "EXP MADIENET EL SALAM", manager: "Eslam Gouda" },
            { shop: "EXP Madinet Elsalam 2", manager: "Eslam Gouda" },
            { shop: "EXP Nady ElSekka", manager: "Eslam Gouda" },
            { shop: "EXP Nasr City 10th dist", manager: "Eslam Gouda" },
            { shop: "Fr El tagamoe EL khames", manager: "Eslam Gouda" },
            { shop: "OB. 20th St", manager: "Eslam Gouda" },
            { shop: "OB. Manshiet Elsad Elaaly", manager: "Eslam Gouda" },
            { shop: "EXP Sadat 3", manager: "Hossam Hafez" },
            { shop: "EXP Wadi EL Natron", manager: "Hossam Hafez" },
            { shop: "OB. Khatatba", manager: "Hossam Hafez" },
            { shop: "OB. Nobria", manager: "Hossam Hafez" },
            { shop: "EXP El Eshreni", manager: "Ibrahim Mahmoud" },
            { shop: "EXP El Haram", manager: "Ibrahim Mahmoud" },
            { shop: "EXP El Lebeny", manager: "Ibrahim Mahmoud" },
            { shop: "EXP Hadayek ElAhram Gate 4", manager: "Ibrahim Mahmoud" },
            { shop: "EXP Hadayek ElMohandseen", manager: "Ibrahim Mahmoud" },
            { shop: "EXP Mesaha Fisal", manager: "Ibrahim Mahmoud" },
            { shop: "EXP Tersaa", manager: "Ibrahim Mahmoud" },
            { shop: "Fr 6 October", manager: "Ibrahim Mahmoud" },
            { shop: "Fr Mazar Mall", manager: "Ibrahim Mahmoud" },
            { shop: "Fr Shehab", manager: "Ibrahim Mahmoud" },
            { shop: "OB. Hadayek 6 October", manager: "Ibrahim Mahmoud" },
            { shop: "OB. Nazlet Batran", manager: "Ibrahim Mahmoud" },
            { shop: "OB. Selim st", manager: "Ibrahim Mahmoud" },
            { shop: "OB. Taawon Faisal", manager: "Ibrahim Mahmoud" },
            { shop: "OB. Tawabek", manager: "Ibrahim Mahmoud" },
            { shop: "EXP Galaa Tanta", manager: "Maged Magdy" },
            { shop: "EXP Tanta", manager: "Maged Magdy" },
            { shop: "Fr Kafr Elzayat", manager: "Maged Magdy" },
            { shop: "OB. Berma", manager: "Maged Magdy" },
            { shop: "OB. Ebiar", manager: "Maged Magdy" },
            { shop: "OB. ElDalgamon New", manager: "Maged Magdy" },
            { shop: "OB. Kafr Elzayat 2", manager: "Maged Magdy" },
            { shop: "OB. Kom Hamada", manager: "Maged Magdy" },
            { shop: "OB. Segar Tanta", manager: "Maged Magdy" },
            { shop: "OB. Tanta Elmodirya", manager: "Maged Magdy" },
            { shop: "OB. Al Ayat", manager: "Michael Fayek" },
            { shop: "Al Agameyin Youth Center", manager: "Michael Fayek" },
            { shop: "Atfiah Youth Center", manager: "Michael Fayek" },
            { shop: "El Borombel Youth Center", manager: "Michael Fayek" },
            { shop: "EXP Ahnsia", manager: "Michael Fayek" },
            { shop: "EXP Beba", manager: "Michael Fayek" },
            { shop: "EXP Naser", manager: "Michael Fayek" },
            { shop: "Fr Central Fayoum", manager: "Michael Fayek" },
            { shop: "OB. El Saff", manager: "Michael Fayek" },
            { shop: "OB. Naser Baniswef", manager: "Michael Fayek" },
            { shop: "EXP Manshayt Naser Mini", manager: "Mohamed Emad" },
            { shop: "EXP Matarya", manager: "Mohamed Emad" },
            { shop: "EXP Saker Korish", manager: "Mohamed Emad" },
            { shop: "EXP Sawah", manager: "Mohamed Emad" },
            { shop: "EXP Sayeda Zenab", manager: "Mohamed Emad" },
            { shop: "EXP Zawya El Hamra", manager: "Mohamed Emad" },
            { shop: "Fr Aghakhan", manager: "Mohamed Emad" },
            { shop: "Fr Hadayek El Koba", manager: "Mohamed Emad" },
            { shop: "Fr Mokkattam", manager: "Mohamed Emad" },
            { shop: "OB. Bassaten2", manager: "Mohamed Emad" },
            { shop: "OB. El Drasa", manager: "Mohamed Emad" },
            { shop: "OB. Mokattam2", manager: "Mohamed Emad" },
            { shop: "EXP Ismailia", manager: "Mostafa Mohamed" },
            { shop: "EXP Ismailia EL-Fardous", manager: "Mostafa Mohamed" },
            { shop: "EXP Salheya", manager: "Mohamed Ragab" },
            { shop: "OB. Ismailia ELHekr", manager: "Omar Elsaid" },
            { shop: "OB. Ismailia EL-Mostashfa", manager: "Omar Elsaid" },
            { shop: "EXP Kanater", manager: "Mohamed Mostafa" },
            { shop: "EXP Nahia", manager: "Mohamed Mostafa" },
            { shop: "EXP NASRCITY 7TH DISTRICT", manager: "Mohamed Mostafa" },
            { shop: "EXP Shabory", manager: "Mohamed Mostafa" },
            { shop: "EXP Shoubra Al Khima", manager: "Mohamed Mostafa" },
            { shop: "EXP Talbia", manager: "Mohamed Mostafa" },
            { shop: "Fr Shoubra El Kema", manager: "Mohamed Mostafa" },
            { shop: "OB. 15May", manager: "Mohamed Mostafa" },
            { shop: "OB. Bahtem", manager: "Mohamed Mostafa" },
            { shop: "OB. Marg 5", manager: "Mohamed Mostafa" },
            { shop: "OB. Bahtem2", manager: "Mohamed Mostafa" },
            { shop: "OB. Bashteel 2", manager: "Mohamed Mostafa" },
            { shop: "OB. Basos", manager: "Mohamed Mostafa" },
            { shop: "OB. El Sayed Hamada", manager: "Mohamed Mostafa" },
            { shop: "OB. Ezbet El Nakhl 3", manager: "Mohamed Mostafa" },
            { shop: "OB. Kafr Tohorms", manager: "Mohamed Mostafa" },
            { shop: "OB. Khanka", manager: "Mohamed Mostafa" },
            { shop: "OB. Khosos", manager: "Mohamed Mostafa" },
            { shop: "EXP ElKharga", manager: "Mohamed Sayed" },
            { shop: "EXP Mostafa Hafez", manager: "Mohamed Sayed" },
            { shop: "Fr Ahly Club", manager: "Mohamed Sayed" },
            { shop: "OB. Ain Shams", manager: "Mohamed Sayed" },
            { shop: "OB. El Hoda", manager: "Mohamed Sayed" },
            { shop: "OB. Matarya", manager: "Mohamed Sayed" },
            { shop: "OB. Sefarat", manager: "Mohamed Sayed" },
            { shop: "EXP Borg El Arab", manager: "Mostafa Adel" },
            { shop: "EXP Ghobryal", manager: "Mostafa Adel" },
            { shop: "EXP Ibrahimia", manager: "Mostafa Adel" },
            { shop: "EXP Nabawy El Mohandess", manager: "Mostafa Adel" },
            { shop: "EXP Syouf", manager: "Mostafa Adel" },
            { shop: "Fr Moharam Bek Alex", manager: "Mostafa Adel" },
            { shop: "OB. Abo Soliman", manager: "Mostafa Adel" },
            { shop: "EXP Ismailia AboSoeir", manager: "Mostafa Mohamed" },
            { shop: "EXP Suez", manager: "Mostafa Mohamed" },
            { shop: "EXP Suez Faisal", manager: "Mostafa Mohamed" },
            { shop: "EXP Suez Kuwait", manager: "Mostafa Mohamed" },
            { shop: "EXP Suez2", manager: "Mostafa Mohamed" },
            { shop: "Fr Suez", manager: "Mostafa Mohamed" },
            { shop: "OB. Ismailia Abo-Atwa", manager: "Mohamed Ragab" },
            { shop: "OB. Nefisha", manager: "Mohamed Ragab" },
            { shop: "OB. Suez ELSalam", manager: "Mostafa Mohamed" },
            { shop: "OB. Suez Oraby", manager: "Mostafa Mohamed" },
            { shop: "EXP Ismailia2", manager: "Mostafa Mohamed" },
            { shop: "Exp Hyper Badr", manager: "Mostafa Mohamed" },
            { shop: "OB. Ismailia1", manager: "Mostafa Mohamed" },
            { shop: "EXP Talia", manager: "Mustafa Shaqery" },
            { shop: "OB. El Mansouria", manager: "Mustafa Shaqery" },
            { shop: "OB. Nekla", manager: "Mustafa Shaqery" },
            { shop: "OB. Wardan1", manager: "Mustafa Shaqery" },
            { shop: "Samadon Youth Center", manager: "Mustafa Shaqery" },
            { shop: "Shmaa Youth Center", manager: "Mustafa Shaqery" },
            { shop: "EXP Quantra", manager: "Omar Elsaid" },
            { shop: "OB. Qantara EL-Moahda", manager: "Omar Elsaid" },
            { shop: "EXP Abo korkas", manager: "Shady Maher" },
            { shop: "EXP Assuit", manager: "Shady Maher" },
            { shop: "EXP Asyut", manager: "Shady Maher" },
            { shop: "EXP Dayr Mawas", manager: "Shady Maher" },
            { shop: "EXP Matay", manager: "Shady Maher" },
            { shop: "EXP New Valley", manager: "Shady Maher" },
            { shop: "EXP Sahel Selim", manager: "Shady Maher" },
            { shop: "OB. Abo Korkas New", manager: "Shady Maher" }
        ];

        async function initAuth() {
            try {
                if (!auth.currentUser) {
                    await signInAnonymously(auth).catch(err => {
                        if (err.code === 'auth/configuration-not-found') {
                            console.warn("Critical: Enable 'Anonymous' provider in Firebase Console.");
                        } else {
                            throw err;
                        }
                    });
                }
            } catch (error) {
                console.error("Auth initialization error:", error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user && user.email) {
                const isAdmin = user.email === 'admin@pyramidsexpress.com';
                window.state.user = { uid: user.uid, email: user.email, name: isAdmin ? 'System Admin' : 'PE Agent' };
                window.state.isLoggedIn = true;
                window.state.isAdmin = isAdmin;
            } else {
                window.state.user = user ? { uid: user.uid, name: 'Guest' } : null;
                window.state.isLoggedIn = false;
                window.state.isAdmin = false;
            }
            setupDataSync();
            render();
        });

        let materialUnsub, userUnsub, shopUnsub, requestUnsub;

        function setupDataSync() {
            if (!auth.currentUser) return;
            
            if (materialUnsub) materialUnsub();
            if (userUnsub) userUnsub();
            if (shopUnsub) shopUnsub();
            if (requestUnsub) requestUnsub();

            const publicDataRef = collection(db, 'artifacts', appId, 'public', 'data', 'materials');
            materialUnsub = onSnapshot(publicDataRef, (snapshot) => {
                const newMaterials = { 'orange-info': [], 'corporate': [], 'incentives': [] };
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (newMaterials[data.category]) {
                        newMaterials[data.category].push({ id: doc.id, ...data });
                    }
                });
                window.state.materials = newMaterials;
                render();
            }, (err) => console.error("Firestore Material Sync Error:", err));

            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
            userUnsub = onSnapshot(usersRef, (snapshot) => {
                const newUsers = [];
                snapshot.forEach((doc) => {
                    newUsers.push({ id: doc.id, ...doc.data() });
                });
                window.state.users = newUsers;
                render();
            }, (err) => console.error("Firestore User Sync Error:", err));

            const shopsRef = collection(db, 'artifacts', appId, 'public', 'data', 'shops');
            shopUnsub = onSnapshot(shopsRef, (snapshot) => {
                const newShops = [];
                snapshot.forEach((doc) => {
                    newShops.push({ id: doc.id, ...doc.data() });
                });
                window.state.shops = newShops;
                updateSignupManagers();
                render();
            }, (err) => console.error("Firestore Shop Sync Error:", err));

            const requestsRef = collection(db, 'artifacts', appId, 'public', 'data', 'requests');
            requestUnsub = onSnapshot(requestsRef, (snapshot) => {
                const newRequests = [];
                snapshot.forEach((doc) => {
                    newRequests.push({ id: doc.id, ...doc.data() });
                });
                window.state.requests = newRequests;
                render();
            }, (err) => console.error("Firestore Request Sync Error:", err));
        }

        window.navigateTo = (page) => {
            window.state.currentPage = page;
            render();
            window.scrollTo(0, 0);
        };

        window.toggleTheme = () => {
            window.state.darkMode = !window.state.darkMode;
            document.documentElement.classList.toggle('dark', window.state.darkMode);
            render();
        };

        window.toggleAuthModal = (show) => {
            const modal = document.getElementById('auth-modal');
            modal.style.display = show ? 'flex' : 'none';
            if (show) toggleAuthView('login');
        };

        window.toggleAuthView = (view) => {
            const loginView = document.getElementById('auth-view-login');
            const signupView = document.getElementById('auth-view-signup');
            if (view === 'signup') {
                loginView.classList.add('hidden');
                signupView.classList.remove('hidden');
                updateSignupManagers();
            } else {
                loginView.classList.remove('hidden');
                signupView.classList.add('hidden');
            }
        };

        window.updateSignupManagers = () => {
            const select = document.getElementById('signup-area');
            if (!select) return;
            const source = window.state.shops.length > 0 
                ? window.state.shops.map(s => s.areaManager)
                : INITIAL_SHOP_DATA.map(s => s.manager);
            const managers = [...new Set(source)].sort();
            select.innerHTML = '<option value="">SELECT AREA MANAGER</option>';
            managers.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m.toUpperCase();
                select.appendChild(opt);
            });
        };

        window.updateSignupShops = () => {
            const manager = document.getElementById('signup-area').value;
            const shopSelect = document.getElementById('signup-shop');
            if (!shopSelect) return;
            shopSelect.innerHTML = '<option value="">SELECT SHOP</option>';
            if (!manager) {
                shopSelect.disabled = true;
                return;
            }
            const source = window.state.shops.length > 0 ? window.state.shops : INITIAL_SHOP_DATA;
            const filteredShops = source
                .filter(s => (s.areaManager || s.manager) === manager)
                .map(s => s.shopName || s.shop)
                .sort();
            filteredShops.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s.toUpperCase();
                shopSelect.appendChild(opt);
            });
            shopSelect.disabled = false;
        };

        window.handleLogin = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('auth-submit-btn');
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            btn.disabled = true;
            btn.innerHTML = 'Verifying...';
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                toggleAuthModal(false);
                navigateTo('admin-panel');
            } catch (err) {
                console.error("Login failed:", err);
                if (err.code === 'auth/configuration-not-found') {
                    alert("Firebase Error: Even though you enabled providers, the API Key in the code might be pointing to a different project or propagation is pending. Double check your config.");
                } else if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
                    alert("Invalid email or password.");
                } else {
                    alert("Login Error: " + err.message);
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Authorize Session';
            }
        };

        window.handleSignUp = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('signup-submit-btn');
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-pass').value;
            const area = document.getElementById('signup-area').value;
            const shop = document.getElementById('signup-shop').value;
            btn.disabled = true;
            btn.innerHTML = 'Submitting...';
            try {
                const requestId = Date.now().toString();
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', requestId), {
                    agentName: name, email, password: pass, areaManager: area, shopName: shop,
                    status: 'pending', createdAt: new Date().toISOString()
                });
                alert("Application submitted! Wait for Admin approval.");
                toggleAuthView('login');
                e.target.reset();
            } catch (err) {
                console.error("Sign up error:", err);
                alert("Submission failed.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Submit Application';
            }
        };

        window.logout = async () => {
            try { await signOut(auth); navigateTo('home'); } catch (e) {}
        };

        function render() {
            const root = document.getElementById('app-root');
            const navLinks = document.getElementById('nav-links');
            if (!root) return;
            const s = window.state;
            
            let navHtml = `<button onclick="navigateTo('home')" class="text-xs uppercase font-bold tracking-widest opacity-60 hover:text-red-600 transition-colors">Home</button>`;
            if (s.isLoggedIn) {
                if (s.isAdmin) {
                    const badge = s.requests.length > 0 ? `<span class="ml-1.5 w-4 h-4 rounded-full bg-red-600 text-white text-[8px] flex items-center justify-center animate-pulse">${s.requests.length}</span>` : '';
                    navHtml += `<button onclick="navigateTo('admin-panel')" class="text-xs uppercase font-bold tracking-widest text-red-600 flex items-center"><i data-lucide="settings" class="w-3.5 h-3.5 mr-1"></i> Management${badge}</button>`;
                } else {
                    navHtml += `<button onclick="navigateTo('agent-dashboard')" class="text-xs uppercase font-bold tracking-widest hover:text-red-600 transition-colors">Dashboard</button>`;
                }
                navHtml += `<div class="flex items-center space-x-4 border-l border-gray-200 dark:border-gray-800 pl-6"><span class="text-xs font-bold opacity-60">${s.user.name}</span><button onclick="logout()" class="text-red-600 hover:opacity-70 transition-opacity"><i data-lucide="log-out" class="w-4 h-4"></i></button></div>`;
            } else {
                navHtml += `<button onclick="toggleAuthModal(true)" class="px-4 py-1.5 rounded text-xs font-bold uppercase tracking-widest ${s.darkMode ? 'bg-red-600 text-white' : 'bg-black text-white'} transition-colors">Agent Login</button>`;
            }
            navLinks.innerHTML = navHtml;

            if (s.currentPage === 'home') root.innerHTML = renderHome();
            else if (s.currentPage === 'agent-dashboard') root.innerHTML = renderDashboard();
            else if (s.currentPage === 'admin-panel') root.innerHTML = renderAdmin();
            else if (s.currentPage.startsWith('service-')) root.innerHTML = renderServiceDetail(s.currentPage.replace('service-', ''));

            lucide.createIcons();
        }

        function renderHome() {
            const gradient = window.state.darkMode ? 'from-black to-red-900' : 'from-black to-orange-600';
            return `<div class="fade-in"><section class="relative h-[450px] w-full mt-0 overflow-hidden flex items-center justify-center"><div class="absolute inset-0 z-0"><img src="https://images.unsplash.com/photo-1522071820081-009f0129c71c?auto=format&fit=crop&q=80&w=2000" class="w-full h-full object-cover brightness-[0.4]" alt="Team"><div class="absolute inset-0 opacity-40 bg-gradient-to-r ${gradient}"></div></div><div class="relative z-10 text-center px-4"><div class="mb-4 inline-block bg-white/10 backdrop-blur-sm border border-white/20 px-4 py-1 rounded text-[10px] font-bold uppercase tracking-[0.2em] text-white">Partner Orange Egypt</div><h1 class="text-5xl md:text-7xl font-black text-white uppercase tracking-tighter leading-none mb-4">One <span class="text-red-600">Team</span> One <span class="text-red-600">Goal</span></h1><p class="text-white text-lg md:text-xl font-light tracking-wide uppercase opacity-90">Reliability & Excellence</p><button onclick="toggleAuthModal(true)" class="mt-8 bg-red-600 text-white px-8 py-3 rounded font-bold uppercase text-xs tracking-widest hover:bg-red-700 transition-all shadow-2xl">Portal Access</button></div></section></div>`;
        }

        function renderDashboard() {
            const services = [
                { id: 'medical', title: 'Medical Insurance', sub: 'Omega Care', icon: 'heart-pulse', type: 'link', url: 'https://lookerstudio.google.com/reporting/01d55067-0527-435e-9e17-5a692003f0b0?s=trQFr5asru8' },
                { id: 'orange-info', title: 'Orange Info', sub: 'Sales & Tariffs', icon: 'globe', type: 'page' },
                { id: 'corporate', title: 'Corporate Materials', sub: 'Internal', icon: 'briefcase', type: 'page' },
                { id: 'incentives', title: 'Incentives', sub: 'Recognition', icon: 'award', type: 'page' }
            ];
            // FIXED: navigateTo instead of MapsTo
            return `<div class="max-w-7xl mx-auto px-4 py-12 fade-in"><div class="mb-12 border-b border-gray-100 dark:border-gray-800 pb-8"><h2 class="text-3xl font-black uppercase tracking-tight mb-2 text-gray-900 dark:text-white">Agent Dashboard</h2><p class="text-gray-500 text-sm uppercase tracking-widest">Authorized Access Only</p></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">${services.map(s => `<div onclick="${s.type === 'link' ? `window.open('${s.url}', '_blank')` : `MapsTo('service-${s.id}')`}" class="group p-8 rounded-2xl border transition-all cursor-pointer ${window.state.darkMode ? 'bg-gray-900 border-gray-800 hover:border-red-600' : 'bg-white border-gray-100 hover:border-black shadow-sm hover:shadow-xl'}"><div class="w-14 h-14 rounded-xl flex items-center justify-center mb-6 transition-colors ${window.state.darkMode ? 'bg-red-600/10 text-red-600' : 'bg-black/5 text-black group-hover:bg-red-600 group-hover:text-white'}"><i data-lucide="${s.icon}" class="w-8 h-8"></i></div><h3 class="font-black uppercase text-lg tracking-tight mb-1">${s.title}</h3><p class="text-red-600 text-xs font-bold uppercase tracking-widest mb-6">${s.sub}</p><div class="flex items-center text-xs font-bold uppercase tracking-widest group-hover:translate-x-2 transition-transform">${s.type === 'link' ? 'Open Link' : 'View Portal'} <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i></div></div>`).join('')}</div></div>`;
        }

        function renderAdmin() {
            const materials = Object.entries(window.state.materials);
            const users = window.state.users;
            const shops = window.state.shops;
            const requests = window.state.requests;
            return `<div class="max-w-7xl mx-auto px-4 py-12 fade-in">
                <div class="mb-12 border-b border-gray-100 dark:border-gray-800 pb-8">
                    <h2 class="text-4xl font-black uppercase tracking-tight mb-2 text-gray-900 dark:text-white">Management</h2>
                    <p class="text-red-600 text-xs font-bold uppercase tracking-widest">Administrator Dashboard</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                    <div class="lg:col-span-1 space-y-6">
                         <div class="p-6 rounded-2xl border ${window.state.darkMode ? 'bg-gray-900 border-gray-800' : 'bg-white border-gray-100 shadow-sm'}">
                            <h3 class="font-black uppercase tracking-widest text-[10px] mb-4 dark:text-white">System Info</h3>
                            <p class="text-[9px] opacity-60 dark:text-gray-400">Current App ID: ${appId}</p>
                            <p class="text-[9px] opacity-60 dark:text-gray-400">Auth Status: ${window.state.isLoggedIn ? 'Authorized' : 'Checking...'}</p>
                         </div>
                    </div>
                    <div class="lg:col-span-3 space-y-8">
                         <p class="text-center py-10 opacity-40">Admin tools and data views are loaded from Firestore.</p>
                    </div>
                </div>
            </div>`;
        }

        function renderServiceDetail(catId) {
            const items = window.state.materials[catId] || [];
            return `<div class="max-w-4xl mx-auto px-4 py-12 fade-in"><button onclick="navigateTo('agent-dashboard')" class="flex items-center text-xs font-bold uppercase tracking-widest text-red-600 mb-8 hover:opacity-70"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Back to Dashboard</button><h1 class="text-4xl font-black uppercase tracking-tighter mb-12 text-gray-900 dark:text-white">${catId.replace('-', ' ')} <span class="text-red-600">Materials</span></h1><div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${items.map(i => `<div class="p-6 rounded-xl border ${window.state.darkMode ? 'bg-gray-900 border-gray-800 hover:bg-gray-800' : 'bg-white border-gray-100 hover:shadow-lg'} transition-all flex justify-between items-center group cursor-pointer"><div><p class="text-xs font-bold uppercase tracking-widest mb-1 dark:text-white">${i.title}</p><p class="text-[9px] font-medium opacity-40 uppercase tracking-tighter dark:text-gray-500">${i.desc || 'System Resource'}</p></div><div class="text-red-600"><i data-lucide="${i.type === 'pdf' ? 'file-text' : i.type === 'video' ? 'video' : 'image'}" class="w-5 h-5"></i></div></div>`).join('')}</div></div>`;
        }

        window.onload = () => {
            document.getElementById('year').textContent = new Date().getFullYear();
            initAuth();
            render();
            lucide.createIcons();
            document.getElementById('login-form').addEventListener('submit', window.handleLogin);
            document.getElementById('signup-form').addEventListener('submit', window.handleSignUp);
        };
    </script>
</body>
</html>
